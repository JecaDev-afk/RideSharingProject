<!DOCTYPE html>
<html>

<head>
    <title>Ride Sharing Demo</title>
    <meta charset="utf-8" />
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }

        .card {
            background: white;
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
        }

        h3 {
            margin-top: 0;
            color: #555;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .status {
            font-weight: bold;
            color: blue;
        }

        #logs {
            background: #1e1e1e;
            color: #0f0;
            padding: 15px;
            height: 300px;
            overflow-y: scroll;
            border-radius: 4px;
            font-family: monospace;
        }

        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
    <!-- –ü—ñ–¥–∫–ª—é—á–∞—î–º–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
</head>

<body>
    <h1>üöñ Ride Sharing System (–Ü–ù–î–ó-2)</h1>

    <div class="card">
        <h3>üëÆ‚Äç‚ôÇÔ∏è –ü–∞–Ω–µ–ª—å –≤–æ–¥—ñ—è</h3>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å —É —Å–∏—Å—Ç–µ–º—ñ —Ç–∞ –ø–æ—á–∞—Ç–∏ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –≥–µ–æ–¥–∞–Ω—ñ.</p>
        <input type="text" id="driverId" placeholder="ID –≤–æ–¥—ñ—è" value="driver1">
        <button onclick="registerDriver()">–í–∏–π—Ç–∏ –Ω–∞ –ª—ñ–Ω—ñ—é</button>
    </div>

    <div class="card">
        <h3>üôã‚Äç‚ôÇÔ∏è –ü–∞–Ω–µ–ª—å –ø–∞—Å–∞–∂–∏—Ä–∞</h3>
        <p>–í–∞—à ID: <strong id="myPassengerId">...</strong></p>
        <button onclick="requestRide()">–ó–∞–º–æ–≤–∏—Ç–∏ —Ç–∞–∫—Å—ñ</button>
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc;">
            <strong>–°—Ç–∞—Ç—É—Å –ø–æ—ó–∑–¥–∫–∏:</strong> <span id="tripStatus" class="status">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–º–æ–≤–ª–µ–Ω—å</span><br>
            <strong>ID –ø–æ—ó–∑–¥–∫–∏:</strong> <span id="currentTripId">-</span>
        </div>
    </div>

    <div class="card">
        <h3>üì° –õ–æ–≥ –ø–æ–¥—ñ–π (Real-Time)</h3>
        <div id="logs"></div>
    </div>

    <script>
        // 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SignalR –∑'—î–¥–Ω–∞–Ω–Ω—è
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/rideHub")
            .withAutomaticReconnect()
            .build();

        let currentTripId = null;

        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ ID –ø–∞—Å–∞–∂–∏—Ä–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        const passengerId = "user_" + Math.floor(Math.random() * 10000);
        document.getElementById("myPassengerId").innerText = passengerId;

        // –°—Ç–∞—Ä—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è
        connection.start()
            .then(() => log("‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ SignalR Hub"))
            .catch(err => log("‚ùå –ü–æ–º–∏–ª–∫–∞ SignalR: " + err));

        // –û–±—Ä–æ–±–∫–∞ –≤—Ö—ñ–¥–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞
        connection.on("RideUpdate", (data) => {
            log(`üîî –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –í–Ü–î –°–ï–†–í–ï–†–ê: –°—Ç–∞—Ç—É—Å=${data.status}, –í–æ–¥—ñ–π ID=${data.driverId}`);

            const statusEl = document.getElementById("tripStatus");
            statusEl.innerText = data.status;

            if (data.status === "MATCHED") {
                statusEl.style.color = "green";
                statusEl.innerText = `üöó –í–û–î–Ü–Ø –ó–ù–ê–ô–î–ï–ù–û! (ID: ${data.driverId})`;
            }
        });

        connection.on("Log", (msg) => {
            log("‚ÑπÔ∏è Info: " + msg);
        });

        // –î—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞
        async function registerDriver() {
            const id = document.getElementById("driverId").value;
            try {
                await fetch('/api/driver/update-location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: id,
                        name: "Test Driver",
                        currentLocation: { lat: 50.45, lon: 30.52 }
                    })
                });
                log(`üöô –í–æ–¥—ñ–π ${id} –≤–∏–π—à–æ–≤ –Ω–∞ –ª—ñ–Ω—ñ—é (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ).`);
            } catch (e) {
                log("‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤–æ–¥—ñ—è: " + e);
            }
        }

        async function requestRide() {
            document.getElementById("tripStatus").innerText = "üîç –ü–û–®–£–ö –í–û–î–Ü–Ø...";
            document.getElementById("tripStatus").style.color = "orange";

            try {
                const response = await fetch('/api/trip/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        passengerId: passengerId,
                        pickupLocation: { lat: 50.45, lon: 30.52 }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    currentTripId = data.tripId;
                    document.getElementById("currentTripId").innerText = currentTripId;

                    log(`üìù –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ (ID: ${currentTripId}). –ß–µ–∫–∞—î–º–æ –Ω–∞ –º–∞—Ç—á–∏–Ω–≥...`);

                    // –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—å –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∞–º–µ —Ü—ñ—î—ó –ø–æ—ó–∑–¥–∫–∏
                    await connection.invoke("JoinRideGroup", currentTripId);
                } else {
                    log("‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è");
                }
            } catch (e) {
                log("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É: " + e);
            }
        }

        function log(message) {
            const el = document.getElementById("logs");
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div><span style="color: #888">[${time}]</span> ${message}</div>`;
            el.scrollTop = el.scrollHeight;
        }
    </script>
</body>

</html>